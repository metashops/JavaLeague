## 一、基本配置

1、MyBatis-Plus

MP是一个MyBatis的增强工具，在他基础上只做增强不做改变，为简化开发、提高效率而生

2、创建User表，脚本如下

```sql
CREATE TABLE USER
(
  id BIGINT(20)NOT NULL COMMENT '主键 ID',
  NAME VARCHAR(30)NULL DEFAULT NULL COMMENT '姓名',
  age INT(11)NULL DEFAULT NULL COMMENT '年龄',
  email VARCHAR(50)NULL DEFAULT NULL COMMENT '邮箱',
  PRIMARY KEY (id)
);
```

3、创建工程，使用springBoot

导入依赖

```
   <!--mybatis-plus 持久层-->
		<dependency>
			<groupId>com.baomidou</groupId>
			<artifactId>mybatis-plus-boot-starter</artifactId>
			<version>3.3.1</version>
		</dependency>
		<!--mysql-->
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<version>8.0.20</version>
		</dependency>
		<!--lombok用来简化实体类-->
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
```

4、配置数据库信息

Resource-->application.properties

```mysql
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=GMT%2B8
spring.datasource.username=root
spring.datasource.password=88tianyun
```

5、项目结构

（1）entity包是编写实体类

（2）mapper包是mybatis，mp就是对mybadis做封装，所以mapper包是编写mapper接口：UserMapper.java

```java
public interface UserMapper extends BaseMapper<User> {
}
```

继承BaseMapper接口，这样就可以直接调用里面封装的所有方法，非常方便

6、测试

在启动类

```
@SpringBootApplication
@MapperScan("com.cathax.demomptest.mapper")
public class DemomptestApplication {
	public static void main(String[] args) {
		SpringApplication.run(DemomptestApplication.class, args);
	}
}
```

由于mapper是动态生成的所以需要添加`@MapperScan("com.cathax.demomptest.mapper")`这样才扫描到

测试

```java
@SpringBootTest
class DemomptestApplicationTests {
	@Autowired
	private UserMapper userMapper;
	@Test
	public void findAll() {
		List<User> users = userMapper.selectList(null);
		System.out.println(users);
	}
}
```

7、查看SQL输出日志，在resource目录下application.properties进行添加配置

```java
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

## 二、使用MP实现添加、修改、删除、查询操作

### 1、添加

```java
//添加
	@Test
	public void testAdd(){
		User user = new User();
		user.setName("Mary");
		user.setAge(20);
		user.setEmail("123@qq.com");
		int insert = userMapper.insert(user);//返回是影响行数
		System.out.println(insert);
	}
```

上处的ID是自动生成19位，也就是我们要将的主键策略。

Mbatis-plus默认的主键策略是：ASSIGN_ID（底层使用雪花算法：分布式ID主成器）

### 2、修改

```java
	//修改
	@Test
	public void testUpdate(){
		User user = new User();
		user.setId(1422448011861475329L);
		user.setName("Lucymary");
		int count = userMapper.updateById(user);//影响行数
		System.out.println(count);
	}
```

MP又一个特性“自动填充”，之前我们修改添加时都是调用`set...`，然后使用MP自动填充就不用set的了。

使用MP自动填充：

第一步：去数据库添加表字段reate_time和update_time，及类型为datetime

第二步：已经在表添加字段，所以应该在实体类添加对应属性

```java
private Date createTime;//注意，在表中我们是这样的reate_time
private Date updateTime;
```

第三步：在实体类进行自动填充属性添加注解

```java
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;//注意，在表中我们是这样的reate_time
    @TableField(fill = FieldFill.UPDATE)
    private Date updateTime;
```

第四步：创建一个类实现接口，实现接口两个方法

一个方法添加执行

一个方法修改执行

```java
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {
    //MP执行添加操作，这方法执行
    @Override
    public void insertFill(MetaObject metaObject) {
        this.setFieldValByName("createTime",new Date(),metaObject);
        this.setFieldValByName("createTime",new Date(),metaObject);
    }
    //MP执行修改操作，该方法执行
    @Override
    public void updateFill(MetaObject metaObject) {
        this.setFieldValByName("createTime",new Date(),metaObject);
    }
}
```



### 3、MP实现乐观锁

注册乐观锁插件，在mybatisPlusConfig中注册Bean

第一步：在表添加字段作为版本号，在表对应实体类添加版本号属性

第二步：在实体类进行版本号操作属性上添加注解

```
    @Version
    @TableField(fill = FieldFill.INSERT)//自动修改
    private Integer version;
```

第三步：配置乐观锁插件

新建config包，在里面编写MpConfig类如下

```java
@Configuration
@MapperScan("com.cathax.demomptest.mapper")
public class MpConfig {
    @Bean
    public OptimisticLockerInterceptor optimisticLockerInterceptor(){
        return new OptimisticLockerInterceptor();
    }
}
```

```
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {
    //MP执行添加操作，这方法执行
    @Override
    public void insertFill(MetaObject metaObject) {
        this.setFieldValByName("version",1,metaObject);//添加这行

    }
}
```

第四步：测试

```java
	//测试乐观锁
	@Test
	public void testOptimisticLocker(){
		//先查再改
		User user = userMapper.selectById(1422483849206980609L);
		//修改
		user.setName("张三");
		userMapper.updateById(user);
	}
```



### 4、查询

（1）通过多个ID批量查询

（3）分页查询

第一步：首先在配置类中添加以下操作

```java
    //分页查询插件
    @Bean
    public PaginationInterceptor paginationInterceptor(){
        return new PaginationInterceptor();
    }
```

第二步：编写分页代码

1）插件page对象，传入两个参数（当前页和每页记录数）

2）调用

```java
//分页查询
	@Test
	public void testSelectPage(){
		Page<User> page = new Page<>(1, 3);
		Page<User> userPage = userMapper.selectPage(page, null);
		//返回对象得到分页所有数据
		long pages = userPage.getPages();//总页数
		long current = userPage.getCurrent();//当前页
		List<User> records = userPage.getRecords();//查询数据集合
		long total = userPage.getTotal();//总记录数
		boolean b = userPage.hasNext();//是否有下一页
		boolean b1 = userPage.hasPrevious();//上页
		//输出
		System.out.println(pages);
		System.out.println(current);
		System.out.println(records);
		System.out.println(total);
		System.out.println(b);
		System.out.println(b1);
	}
```

























