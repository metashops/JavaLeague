## 一、中央处理器（CPU）

CPU 的工作模式，硬件中最重要的就是 CPU，它就是执行程序的核心部件。而我们常用的电脑就是 x86 平台，所以我们要对 x86 CPU 有一些基本的了解。

按照 CPU 功能升级迭代的顺序，CPU 的工作模式有实模式、保护模式、长模式。

### 1、实模式

#### （1）实模式寄存器

由于 CPU 是根据指令完成相应的功能。下图我们就去看看 x86 CPU 在实模式下的寄存器。表中每个寄存器都是 16 位的。

![WeChat7e7a5ec687bd723528131b055b922cc6.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtinpww2cnj30rs0eq43r.jpg)

> * AX寄存器称为累加器（Accumulator），使用时主要用于存放数据，如存放算术、逻辑运算中的操作数或结果。也可临时时用于存放地址。
>
> * BX寄存器称为基址寄存器（BaseRegister），常用来存放访问存储器时的地址。
> *  CX寄存器称为计数寄存器（CountRegister），常用于保存计算值，如在移位指令，循环（loop）和串处理指令中用作隐含的计数器。 
> * DX寄存器称为数据寄存器（DataRegister），常用于数据传递。在寄存器间接寻址中的I／O指令中存放I／O端口的地址。

虽然有了寄存器，但是数据和指令都是存放在内存中的。通常情况下，需要把数据装载进寄存器中才能操作，还要有获取指令的动作，这些都要访问内存才行，而我们知道访问内存靠的是地址值。

#### （2）实模式中断

**什么是中断？**

中断即中止执行当前程序，转而跳转到另一个特定的地址上，去运行特定的代码。

**中断是如何产生的呢？**

第一种情况是，中断控制器给 CPU 发送了一个电子信号，CPU 会对这个信号作出应答。随后中断控制器会将中断号发送给 CPU，这是硬件中断。

第二种情况就是 CPU 执行了 INT 指令，这个指令后面会跟随一个常数，这个常数即是软中断号。这种情况是软件中断。

### 2、保护模式

内存一大，首先要解决的问题是寻址问题，因为 16 位的寄存器最多只能表示 216 个地址，所以 CPU 的寄存器和运算单元都要扩展成 32 位的。

#### （1）保护模式寄存器

保护模式相比于实模式，增加了一些控制寄存器和段寄存器，扩展通用寄存器的位宽，所有的通用寄存器都是 32 位的，还可以单独使用低 16 位，这个低 16 位又可以拆分成两个 8 位寄存器，如下表。

![WeChat711db6c981a9c1a2bddb4404d232edda.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtiodka9ldj30rs0geagu.jpg)

### 3、长模式

#### （1）长模式寄存器

长模式相比于保护模式，增加了一些通用寄存器，并扩展通用寄存器的位宽，所有的通用寄存器都是 64 位，还可以单独使用低 32 位。

![WeChatce914524aaba02d5336e1a71d04a3145.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtio7od4o9j30rs0ge45n.jpg)

#### （2）长模式中断

保护模式下为了实现对中断进行权限检查，实现了中断门描述符，在中断门描述符中存放了对应的段选择子和其段内偏移，还有 DPL 权限，如果权限检查通过，则用对应的段选择子和其段内偏移装载 CS:EIP 寄存器。

### 4、总结

本章介绍了CPU是如何执行指令，我们最重要要知道CPU的任务是什么？

#### （1）中央处理器（CPU）由运算器和控制器组成。

![WeChat9d291bcb17489d706ce902c81faefa0a.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtipfnse6qj30w80jmdih.jpg)

#### （2）CPU的功能

1. 指令控制：完成取指令、分析指令和执行指令的操作，即程序的顺序控制。
2. 操作控制：一条指令的功能往往由若干个操作信号的组合来实现。CPU管理并产生由内存取出的每一条指令的操作信号，把各种操作信号送往相应的部件，从而控制这些部件按指令的要求进行执行。
3. 时间控制：对各种操作加以时间上控制。
4. 数据加工：对数据进行算术和逻辑运算。
5. 中断处理：对计算机运行过程中出现异常情况和特殊请求进行处理

## 二、虚幻与真实：程序中的地址如何转换？

前面小结我们知道，CPU执行程序、处理数据要和内存打交道，在CPU读取指令、读写数据都要先告诉内存芯片的。

首先，思考几个问题：

虚拟地址能解决什么问题？

虚拟地址如何映射为物理地址？

如何解决内存容量问题？

### 虚拟地址

虚拟地址是逻辑上存在的一个数据值。程序经过编译步骤后，还需要链接器将多个代码模块组装成一个完整模块，并解决模块之间的引用，即处理程序代码间的地址引用，形成程序运行的静态内存空间视图。

### 物理地址

虽然虚拟地址解决了很多问题，但是虚拟地址只是逻辑上存在的地址，无法作用于硬件电路的，程序装进内存中想要执行，就需要和内存打交道，从内存中取得指令和数据。而内存只认一种地址，那就是**物理地址**。

### 虚拟地址到物理地址的转换（面试高频）

使用MMU（内存管理单元），MMU 可以接受软件给出的地址对应关系数据，进行地址转换。

我们先来看看逻辑上的 MMU 工作原理框架图。如下图所示：

![WeChat993129fc2538c82191ea0a5dbfdd117e.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtir41vh5fj30rs0fewfs.jpg)

但是问题来了，一个虚拟地址对应一个物理地址，如32 位地址空间下，4GB 虚拟地址的地址关系转换表就会把整个 32 位物理地址空间用完，这显然不行。

综合刚才的分析，把虚拟地址空间和物理地址空间都分成同等大小的块，也称为页，按照虚拟页和物理页进行转换。这样就出现了**内存管理分页模型**。分页模型框架，如下图所示：

![WeChat6c2121b514b41797065eea0703586d39.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gtiracuh8ij30rs0jeq6m.jpg)

## 三、Cache与内存：程序放在哪儿？

### 1、局部性原

想要理解虚拟内存技术的思想，首先须了解著名的局部性原理。

