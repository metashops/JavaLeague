## Redis

#### 1、你说一下Redis有哪些常见类型？

快速回答：**string**、**list**、**hash**、**set**、**zset**五种常见数据类型，我相信几乎谁都知道吧。

但是，如果你要大部人脱颖而出突出与其他人不同，你是不是都来点不一样的呢？那是必须的，还需要加上这几种数据结构**bitmap、HyperLogLog、Geo、Pub/Sub、stream**。

如果你还想加分，那你说还玩过**Redis Module**，像**BloomFilter，RedisSearch，Redis-ML，**这个时候面试官得眼睛就开始发亮了，心想这个小伙子**有点东西啊**。

> String字符类型、Hash散列类型、List列表类型、Set集合类型、Zset有序集合类型、Bitmap位图、HyperLogLog统计、GEO地理、Stream流（用于对日志数据结构进行建模）

Redis数据结构应用场景：

> 细节：Redis命令不区分大小写，但是key是区分的；help命令帮助你对哪些不熟悉的命令:`127.0.0.1:6379> help @string`

**（1）String场景**：商品编号、订单号采用INCR命令生成、点赞数、文章阅读量这些

**（2）Hash场景**：购物车

```
# shopcar:uid101淘宝的购物车，2048是你加入购物车的商品ID，1表已加入购物，0就没有加入
hset shopcar:uid101 2048 1
# 添加商品数量，表示添加数量
hincrby shopcar:uid101 2048 1
```

**（3）List场景**：发布与订阅及消息队列、慢查询。（比如微信文章公众号）

**（4）Set场景**：无序无重复。（重要喔社交类的网站）

复习基本操作：

* 添加元素：sadd key member
* 删除元素：srem key member
* 获取集合所有元素：smembers key
* 判断元素是否在集合：sismember key member
* 获取集合中的元素个数：scard key
* 从集合中随机弹出一个元素，元素不删除：srandmember key 2[你想随机抽出几个]
* 从集合中随机弹出一个元素，出一个删除一个：spop set01 2[你想随机抽出几个]

* 集合的差集：属于A但不属于B的元素构成集合（sdiff key）
* 集合的交集：sinter key
* 集合的并集：sunion key

场景：

* 微信抽奖小程序

![Snip20211002_36.png](http://ww1.sinaimg.cn/large/006FuVcvgy1gv0s91j6r8j60my0pegqt02.jpg)

|         功能         |                         对应使用命令                         |
| :------------------: | :----------------------------------------------------------: |
| 用户ID，按“点击参与” |                       sadd key 用户ID                        |
| 显示“已有3804人参与” |                      Scard key（统计）                       |
|   抽奖“一二三等奖”   | spop key 3（随机抽奖3个人，获得奖者后就删除）；srandmember key 2（随机抽奖2人，元素不删除） |

* 微信朋友圈点赞：点赞就是添加，取消就是删除
* 微博好友关注社交关系：如共同关注的人（求交集）
* QQ内推可能认识的人：差集运算（sdiff key1 key2：表示key2可能认识key1的人；反之sdiff key2 key1）

**（5）Zset场景**：

基本操作命令：

* 向有序集合加入一个元素和该元素的分数：add key score member [score member...]
* 按照元素大小从小-大排序：
* 返回索引start-stop之间元素：zrange key start stop
* 获取元素的分数：zscore key [member ...]
* 删除元素：zrem key member [member ...]
* 获取指定分数范围的元素：zrangebyscore key min max 【 withscores 】【limit offset count】
* 增加某个元素的分数：zincrby key increment member
* 获取集合中元素的数量：zcard key
* 获取指定分数范围内元素个数：zcount key min max
* 按照排序名范围删除元素：zremrangebyrank key start stop

场景：

* 商品销量排行榜，案例如下：

|                        案例                        |               操作命令                |
| :------------------------------------------------: | :-----------------------------------: |
|      商品编号101销量为8，商品编号102销量为90       |   zadd goods:sellsort 9 101 90 102    |
| 如有客户买了5件商品101，那么我们在编号101销量增加5 |     zincrby goods:sellsort 5 101      |
|                  求商品销量前10名                  | zrange goods:sellsort 0 10 withscores |

* 抖音、微博等热搜榜

---

#### 2、分布式锁

你了解分布式锁吗？

> 问题：
>
> * Redis除了拿来做缓存，还可以怎么用呢？
> * Redis做分布式锁时候有需要注意哪些问题？
> * 如果redis是单点部署，会带来哪些问题？你如解决单点问题？
> * 集群模式下，比如主从模式，有没有什么问题？
> * 那你简单介绍一下Redlock？你简历上写redisson是什么？
> * Redis分布式锁如何续期？看门狗知道吗？

分布式锁使用场景：多个服务键+保证同一时刻内+同一用户只能有一个请求（防止关键业务出现数据冲突和并发错误）











---

#### 3、Redis 缓存过期策略？

（1）如何查看Redis最大占用内存？通过配置文件，默认是使用最大内存的的。

（2）一般生产上你如何配置？Redis推荐配置为最大物理内存的四分之三。（0.75）

（3）你如何设置Redis内存大小？通过配置文件或者命令的方式

配置文件：

```redis
# maxmemory <bytes> 注意转换
maxmemory 104857600
```

命令行方式：

```redis
config get maxmemory    #查看Redis内存大小
config set maxmemory 1  #设置
```

还有可以通过：`info memory`

（4）如果Redis内存满了会出现什么情况？**会出现OOM**

面试问你这个问题，其实它是想问你，当Redis满了之后，如何避免类似情况呢？此时引出内存淘汰策略。

（5）Redis 缓存淘汰策略

Redis内存淘汰策略，默认有8种。

首先了解不用淘汰策略的时候，三种不同的删除策略：

* 定时删除：对CPU不友好，用处理器性能换取存储空间
* 懒性删除：对内存不友好，用存储空间换取处理性能
* 定期删除：指定每隔一段时间执行一次删除过期键操作，采用随机抽取的策略，利用过期数据占比的方式控制删除频度，会导致很多Key到过期时间并没有被删除。

上面都有缺点，此时我们使用Redis提供的8种内存淘汰策略，版本6.2.5：

* noeviction：不会驱逐任何Key
* allkeys-lru：对所有Key使用LRU算法进行删除
* volatile-lru：对所有设置过期时间的Key使用LRU算法进行删除
* allkeys-random：对所有Key随机删除
* volatile-random：对所有设置了过期时间的Key随机删除
* volatile-ttl：删除马上要过期的Key
* allkeys-lfu：对所有Key使用LFU算法进行删除
* volatile-lfu：对所有设置了过期时间的Key使用LFU算法进行删除

> LRU means Least Recently Used #最近最少使用（时间上）
>
> LFU means Least Frequently Used #最近最少使用（频率度）

连环问：你公司使用哪一种？或你平时使用哪一种？

一般使用`allkeys-lru`，如何配置呢？通过配置文件`maxmemory-policy allkeys-lru`，或命令行方式：`config set maxmemory-policy allkeys-lru `



什么是LRU算法？

最近最少使用的数据给以淘汰，是一种常用的页面置换算法。